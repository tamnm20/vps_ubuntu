FROM ubuntu:20.04

# ðŸ”§ DISK OPTIMIZATION - Giáº£m image size
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Ho_Chi_Minh \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# ðŸ”§ MEMORY OPTIMIZATION - CÃ i packages trong 1 layer Ä‘á»ƒ giáº£m size
RUN apt-get update && apt-get install -y --no-install-recommends \
    apt update && apt install -y build-essential\
    openssh-server \
    sudo \
    curl \
    wget \
    nano \
    vim \
    git \
    htop \
    net-tools \
    iputils-ping \
    ca-certificates \
    gnupg \
    lsb-release \
    # ðŸ”§ MONITORING TOOLS (cÃ¡c commands free, vmstat, df, du Ä‘Ã£ cÃ³ sáºµn)
    sysstat \
    iotop \
    ncdu \
    procps \
    coreutils \
    # Clean up trong cÃ¹ng layer Ä‘á»ƒ giáº£m size
    && apt-get autoremove -y \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* \
    && rm -rf /var/cache/apt/* \
    && rm -rf /tmp/* \
    && rm -rf /var/tmp/*

# ðŸ”§ SSH Configuration
RUN mkdir /var/run/sshd && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# ðŸ”§ USER MANAGEMENT vá»›i disk quota (náº¿u cáº§n)
RUN useradd -m -s /bin/bash -G sudo tam && \
    echo "tam:1" | chpasswd && \
    usermod -aG sudo tam && \
    echo "root:1234" | chpasswd
# ðŸ”§ SYSTEM LIMITS Configuration
RUN echo '# System Resource Limits\n\
# ðŸ”§ Memory limits\n\
* soft memlock 1048576\n\
* hard memlock 1048576\n\
# ðŸ”§ Process limits\n\
* soft nproc 4096\n\
* hard nproc 8192\n\
# ðŸ”§ File descriptor limits\n\
* soft nofile 65536\n\
* hard nofile 65536\n\
# ðŸ”§ User-specific limits\n\
vpsuser soft nproc 2048\n\
vpsuser hard nproc 4096\n\
' > /etc/security/limits.conf

# ðŸ”§ DISK CLEANUP Script
RUN echo '#!/bin/bash\n\
# Disk cleanup script\n\
echo "ðŸ§¹ Cleaning up disk space..."\n\
apt-get autoremove -y\n\
apt-get autoclean\n\
rm -rf /var/log/*.log\n\
rm -rf /tmp/*\n\
rm -rf /var/tmp/*\n\
find /var/log -type f -name "*.log" -delete\n\
echo "âœ… Cleanup completed!"\n\
df -h\n\
' > /usr/local/bin/cleanup-disk.sh && chmod +x /usr/local/bin/cleanup-disk.sh

# ðŸ”§ RESOURCE MONITORING Script  
RUN echo '#!/bin/bash\n\
echo "ðŸ“Š SYSTEM RESOURCES MONITORING"\n\
echo "================================"\n\
echo "ðŸ’¾ MEMORY USAGE:"\n\
free -h\n\
echo ""\n\
echo "ðŸ–¥ï¸ CPU USAGE:"\n\
top -bn1 | head -5\n\
echo ""\n\
echo "ðŸ’½ DISK USAGE:"\n\
df -h\n\
echo ""\n\
echo "ðŸ“ TOP DISK USAGE:"\n\
du -sh /* 2>/dev/null | sort -hr | head -10\n\
echo ""\n\
echo "ðŸ”„ RUNNING PROCESSES:"\n\
ps aux --sort=-%mem | head -10\n\
' > /usr/local/bin/monitor-resources.sh && chmod +x /usr/local/bin/monitor-resources.sh

# âœ… Báº­t mÃ u sáº¯c cho ls (báº±ng alias + cáº¥u hÃ¬nh shell)
RUN echo "alias ls='ls --color=auto'" >> /etc/bash.bashrc && \
    echo "export PS1='\\[\\033[01;32m\\]\\u@\\h\\[\\033[00m\\]:\\[\\033[01;34m\\]\\w\\[\\033[00m\\]\\$ '" >> /etc/bash.bashrc

# ðŸ”§ STARTUP Script vá»›i resource monitoring
RUN echo '#!/bin/bash\n\
echo "ðŸš€ Starting Ubuntu VPS..."\n\
echo "ðŸ“Š Initial resource check:"\n\
/usr/local/bin/monitor-resources.sh\n\
echo ""\n\
echo "ðŸ”‘ Starting SSH service..."\n\
service ssh start\n\
echo "âœ… VPS ready!"\n\
echo ""\n\
echo "ðŸ’¡ Useful commands:"\n\
echo "   monitor-resources.sh  - Check system resources"\n\
echo "   cleanup-disk.sh       - Clean up disk space"\n\
echo "   htop                  - Interactive process viewer"\n\
echo "   ncdu /                - Disk usage analyzer"\n\
echo ""\n\
# Keep container running\n\
tail -f /dev/null\n\
' > /start.sh && chmod +x /start.sh

# ðŸ”§ EXPOSE PORTS
EXPOSE 22

# ðŸ”§ HEALTHCHECK Ä‘á»ƒ monitor tÃ i nguyÃªn
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD service ssh status || exit 1

CMD ["/start.sh"]